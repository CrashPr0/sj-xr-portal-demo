<script>
  // ============================================================
  // GEO-LOCK CONFIG
  // ============================================================
  const GEO_LOCK_ENABLED = true;

  const ALLOWED_ZONES = [
    { name: "Shark Target Zone", lat: 37.41684550842396, lon: -121.9585640598993, radiusM: 150 },
  ];

  const USE_FIRST_GPS_FIX_AS_ZONE = false;

  // ============================================================
  // State + Elements
  // ============================================================
  const statusLine = document.getElementById("statusLine");

  const modeAuto = document.getElementById("modeAuto");
  const modeDay = document.getElementById("modeDay");
  const modeNight = document.getElementById("modeNight");

  // 'auto' | 'day' | 'night'
  let lightingMode = "auto";
  let lastFix = null;

  window.__GEO_UNLOCK__ = {
    inAllowedZone: false,
    bestZoneName: null,
    bestDistM: null,
    _setFirstZone: false,
  };

  // ============================================================
  // ON-SCREEN ERROR REPORTING (this is the big improvement)
  // ============================================================
  function setStatusText(txt) {
    if (!statusLine) return;
    statusLine.textContent = txt;
  }

  window.addEventListener("error", (e) => {
    setStatusText(
      `JS ERROR:\n${e.message}\n${(e.filename || "").split("/").slice(-1)[0]}:${e.lineno}:${e.colno}`
    );
  });

  window.addEventListener("unhandledrejection", (e) => {
    const r = e.reason;
    setStatusText(`PROMISE ERROR:\n${r?.message || String(r)}`);
  });

  // ============================================================
  // Helpers
  // ============================================================
  function toRad(d) { return d * Math.PI / 180; }
  function haversineMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // ============================================================
  // Day/Night
  // ============================================================
  function isNightAt(lat, lon, date = new Date()) {
    // If SunCalc failed to load, fall back to clock.
    if (!window.SunCalc) return isNightByClock(date);
    const pos = SunCalc.getPosition(date, lat, lon);
    const altitudeDeg = pos.altitude * 180 / Math.PI;
    return altitudeDeg < -6; // civil twilight
  }

  function isNightByClock(date = new Date()) {
    const h = date.getHours();
    return h >= 19 || h < 7;
  }

  function applyLighting(night) {
    const ambient = document.getElementById("ambientLight");
    const dir = document.getElementById("dirLight");
    if (!ambient || !dir) return;

    if (night) {
      ambient.setAttribute("light", "intensity", 0.35);
      ambient.setAttribute("light", "color", "#223344");
      dir.setAttribute("light", "intensity", 0.65);
      dir.setAttribute("light", "color", "#88aaff");
    } else {
      ambient.setAttribute("light", "intensity", 0.9);
      ambient.setAttribute("light", "color", "#ffffff");
      dir.setAttribute("light", "intensity", 1.2);
      dir.setAttribute("light", "color", "#ffffff");
    }
  }

  function setCardTexture(night) {
    const plane = document.getElementById("cardPlane");
    if (!plane) return;
    plane.setAttribute("material", "src", night ? "#nightImg" : "#dayImg");
  }

  function resolveNight() {
    if (lightingMode === "day") return false;
    if (lightingMode === "night") return true;
    if (lastFix?.coords) {
      const { latitude, longitude } = lastFix.coords;
      return isNightAt(latitude, longitude);
    }
    return isNightByClock();
  }

  // ============================================================
  // Marker follow + grace + geo lock awareness
  // ============================================================
  AFRAME.registerComponent("stadium-follow-marker", {
    schema: { graceMs: { type: "int", default: 800 } },
    init: function () {
      this.marker = document.querySelector("#sjsuMarker");
      this.anchor = this.el;
      this.stadium = this.anchor.querySelector("#stadium");
      this.card = this.anchor.querySelector("#dayNightCard");

      this.tracking = false;
      this.hideTimeout = null;
      this.wasVisible = false;

      this.anchor.object3D.visible = false;
      if (this.card) this.card.setAttribute("visible", false);

      if (!this.marker) {
        console.warn("stadium-follow-marker: #sjsuMarker not found");
        return;
      }

      this.marker.addEventListener("markerFound", () => this.onMarkerFound());
      this.marker.addEventListener("markerLost", () => this.onMarkerLost());
      window.addEventListener("geo-unlock-changed", () => this.onGeoUnlockChanged());
    },

    isUnlocked: function () {
      if (!GEO_LOCK_ENABLED) return true;
      return !!(window.__GEO_UNLOCK__ && window.__GEO_UNLOCK__.inAllowedZone);
    },

    showContent: function () {
      this.anchor.object3D.visible = true;
      this.wasVisible = true;

      if (this.stadium) {
        this.stadium.setAttribute("scale", "0.003 0.003 0.003");
        this.stadium.setAttribute("position", "0 -0.2 0");
        this.stadium.emit("popin");
      }

      if (this.card) {
        this.card.setAttribute("visible", true);
        this.card.setAttribute("scale", "0.001 0.001 0.001");
        this.card.emit("cardpop");
      }
    },

    hideContent: function () {
      this.anchor.object3D.visible = false;
      this.wasVisible = false;
      if (this.card) this.card.setAttribute("visible", false);
    },

    onMarkerFound: function () {
      this.tracking = true;

      if (this.hideTimeout) {
        clearTimeout(this.hideTimeout);
        this.hideTimeout = null;
      }

      if (!this.isUnlocked()) {
        this.hideContent();
        return;
      }
      this.showContent();
    },

    onMarkerLost: function () {
      this.tracking = false;
      this.hideTimeout = setTimeout(() => {
        if (!this.tracking) this.hideContent();
      }, this.data.graceMs);
    },

    onGeoUnlockChanged: function () {
      if (!this.tracking) return;
      if (this.isUnlocked()) {
        if (!this.wasVisible) this.showContent();
      } else {
        this.hideContent();
      }
    },

    tick: function () {
      if (!this.tracking || !this.marker) return;
      this.anchor.object3D.position.copy(this.marker.object3D.position);
      this.anchor.object3D.quaternion.copy(this.marker.object3D.quaternion);
    },
  });

  // ============================================================
  // Geo + zones
  // ============================================================
  function computeBestZone(lat, lon) {
    if (USE_FIRST_GPS_FIX_AS_ZONE && !window.__GEO_UNLOCK__._setFirstZone) {
      window.__GEO_UNLOCK__._setFirstZone = true;
      return { inZone: true, bestZoneName: "TEST MODE (first fix)", bestDistM: 0 };
    }

    let bestName = null;
    let bestDist = Infinity;
    let bestInZone = false;

    for (const z of ALLOWED_ZONES) {
      const d = haversineMeters(lat, lon, z.lat, z.lon);
      if (d < bestDist) {
        bestDist = d;
        bestName = z.name;
        bestInZone = d <= z.radiusM;
      }
    }
    return { inZone: bestInZone, bestZoneName: bestName, bestDistM: bestDist };
  }

  function emitGeoUnlockChanged(prevIn, nextIn) {
    if (prevIn !== nextIn) window.dispatchEvent(new Event("geo-unlock-changed"));
  }

  // ============================================================
  // Status update (always runs)
  // ============================================================
  function updateStatus(sourceLabel = "boot") {
    const unlock = window.__GEO_UNLOCK__;
    const inZone = unlock?.inAllowedZone;
    const zoneName = unlock?.bestZoneName || "â€”";
    const dist = unlock?.bestDistM;

    const night = resolveNight();
    applyLighting(night);
    setCardTexture(night);

    const modeLabel =
      lightingMode === "auto" ? "AUTO" :
      lightingMode === "day" ? "FORCED DAY" :
      "FORCED NIGHT";

    let gpsLine = `GPS: not used (${sourceLabel})`;
    if (lastFix?.coords) {
      const { latitude, longitude, accuracy } = lastFix.coords;
      gpsLine = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)} (Â±${Math.round(accuracy)}m)`;
    }

    const lockLine = GEO_LOCK_ENABLED
      ? `Geo-lock: ${inZone ? "UNLOCKED âœ…" : "LOCKED ðŸ”’"} | Closest: ${zoneName} | Dist: ${dist == null ? "â€”" : Math.round(dist) + "m"}`
      : `Geo-lock: OFF`;

    setStatusText(
      `${gpsLine}\n${lockLine}\nLighting: ${night ? "NIGHT" : "DAY"} (${modeLabel}) | Card: ${night ? "night.png" : "day.png"}`
    );
  }

  function setLightingMode(next) {
    lightingMode = next;
    updateStatus(lastFix ? "gps+suncalc" : "clock");
  }

  function wireDayNightToggle() {
    // If IDs got changed/removed, don't crash the whole app.
    if (!modeAuto || !modeDay || !modeNight) {
      setStatusText(
        `UI ERROR: Missing toggle inputs.\nExpected IDs: modeAuto, modeDay, modeNight.\nFix IDs or re-paste header HTML.`
      );
      return;
    }

    const onChange = () => {
      if (modeDay.checked) return setLightingMode("day");
      if (modeNight.checked) return setLightingMode("night");
      setLightingMode("auto");
    };

    modeAuto.addEventListener("change", onChange);
    modeDay.addEventListener("change", onChange);
    modeNight.addEventListener("change", onChange);
  }

  function startGeoWatcher() {
    updateStatus("clock");

    if (!navigator.geolocation) return;

    navigator.geolocation.watchPosition(
      (pos) => {
        lastFix = pos;
        const { latitude, longitude } = pos.coords;

        const prev = !!window.__GEO_UNLOCK__.inAllowedZone;
        const z = computeBestZone(latitude, longitude);

        window.__GEO_UNLOCK__.inAllowedZone = z.inZone;
        window.__GEO_UNLOCK__.bestZoneName = z.bestZoneName;
        window.__GEO_UNLOCK__.bestDistM = z.bestDistM;

        emitGeoUnlockChanged(prev, z.inZone);
        updateStatus("gps+suncalc");
      },
      () => {
        if (GEO_LOCK_ENABLED) {
          const prev = !!window.__GEO_UNLOCK__.inAllowedZone;
          window.__GEO_UNLOCK__.inAllowedZone = false;
          window.__GEO_UNLOCK__.bestZoneName = "â€”";
          window.__GEO_UNLOCK__.bestDistM = null;
          emitGeoUnlockChanged(prev, false);
        }
        updateStatus("clock (gps denied)");
      },
      { enableHighAccuracy: true, maximumAge: 60000, timeout: 15000 }
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Show something immediately (kills "Loadingâ€¦" forever even if geo fails)
    setStatusText("Bootingâ€¦");

    // IMPORTANT: wire toggles defensively; never let it crash init
    try { wireDayNightToggle(); } catch (e) { setStatusText(`Toggle init error: ${e.message}`); }

    try { startGeoWatcher(); } catch (e) { setStatusText(`Geo init error: ${e.message}`); }

    // Periodic refresh
    setInterval(() => updateStatus(lastFix ? "gps+suncalc" : "clock"), 60 * 1000);
  });
</script>
