<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>San Jose XR Portal – Stadium + Day/Night Card</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="WebAR demo: marker stadium + floating day/night card (PNG textures)." />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>

    <!-- Sun position (day/night) -->
    <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #000;
        color: #fff;
      }

      #info {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10;
        text-align: center;
      }
      #info strong { color: #ffd54f; }

      #statusLine {
        margin-top: 0.35rem;
        font-size: 0.75rem;
        opacity: 0.95;
        color: #b6ffdf;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <div id="info">
      Point your camera at a <strong>Hiro marker</strong> (cube) or the <strong>SJSU marker</strong> (stadium).<br />
      Stadium pops up + lingers after marker loss. Card above it switches Day/Night.
      <div id="statusLine">Loading…</div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="antialias: true; alpha: true;"
      arjs="sourceType: webcam; patternRatio: 0.50; debugUIEnabled: false;"
    >
      <!-- Lights we can change day/night -->
      <a-entity id="ambientLight" light="type: ambient; intensity: 0.9; color: #ffffff"></a-entity>
      <a-entity id="dirLight" light="type: directional; intensity: 1.2; color: #ffffff" position="1 2 1"></a-entity>

      <!-- Assets -->
      <a-assets>
        <a-asset-item id="stadiumModel" src="assets/stadium.glb"></a-asset-item>

        <!-- Day/Night images (converted from PDFs) -->
        <img id="dayImg" src="assets/day.png" crossorigin="anonymous" />
        <img id="nightImg" src="assets/night.png" crossorigin="anonymous" />
      </a-assets>

      <!-- 1) Hiro marker (baseline/debug) -->
      <a-marker preset="hiro">
        <a-ring
          position="0 0.01 0"
          rotation="-90 0 0"
          radius-inner="0.4"
          radius-outer="0.7"
          color="#ffffff"
          opacity="0.7"
          animation__pulse="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1200; easing: easeInOutSine"
        ></a-ring>

        <a-box
          position="0 0.5 0"
          depth="0.8"
          height="0.8"
          width="0.8"
          color="#4CC3D9"
          animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"
          animation__hover="property: position; from: 0 0.45 0; to: 0 0.6 0; dir: alternate; loop: true; dur: 1400; easing: easeInOutSine"
        ></a-box>

        <a-text value="Hiro marker (debug)" position="-1.1 1.2 0" color="#ffff66" side="double" wrap-count="22"></a-text>
      </a-marker>

      <!-- 2) SJSU marker used only as tracker -->
      <a-marker id="sjsuMarker" type="pattern" url="markers/sjsu-logo.patt" emitevents="true"></a-marker>

      <!-- 3) Stadium anchor that follows marker and has grace period -->
      <a-entity id="stadiumAnchor" stadium-follow-marker="graceMs: 800">
        <!-- Portal ring -->
        <a-ring
          position="0 0.01 0"
          rotation="-90 0 0"
          radius-inner="0.45"
          radius-outer="0.8"
          color="#00ffaa"
          opacity="0.8"
          animation__pulse="property: scale; from: 1 1 1; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1400; easing: easeInOutSine"
        ></a-ring>

        <!-- Stadium model -->
        <a-entity
          id="stadium"
          gltf-model="#stadiumModel"
          position="0 -0.2 0"
          rotation="0 45 0"
          scale="0.001 0.001 0.001"
          animation__popin="property: scale; to: 0.06 0.06 0.06; dur: 800; easing: easeOutBack; startEvents: popin;"
          animation__rise="property: position; to: 0 0 0; dur: 800; easing: easeOutCubic; startEvents: popin;"
          animation__rotate="property: rotation; to: 0 405 0; loop: true; dur: 15000; easing: linear;"
        ></a-entity>

        <a-text
          value=""
          position="-1.4 8.3 0"
          color="#00FFAA"
          side="double"
          wrap-count="28"
          animation__float="property: position; from: -1.4 1.2 0; to: -1.4 1.4 0; dir: alternate; loop: true; dur: 1600; easing: easeInOutSine"
        ></a-text>

        <!-- Floating Day/Night Card (pops in on markerFound) -->
        <a-entity
          id="dayNightCard"
          visible="false"
          position="0 1.15 0"
          rotation="-10 0 0"
          scale="0.001 0.001 0.001"
          animation__popin="property: scale; to: 1 1 1; dur: 650; easing: easeOutBack; startEvents: cardpop;"
        >
          <!-- Back plate -->
          <a-plane
            width="1.15"
            height="1.55"
            position="0 0 -0.01"
            material="shader: flat; color: #111; opacity: 0.85; transparent: true"
          ></a-plane>

          <!-- Image plane -->
          <a-plane
            id="cardPlane"
            width="1.05"
            height="1.45"
            material="shader: flat; src: #dayImg; side: double;"
          ></a-plane>

          <!-- hover -->
          <a-entity animation="property: position; to: 0 0.06 0; dir: alternate; loop: true; dur: 1400; easing: easeInOutSine"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // -----------------------------
      // Marker follow + grace period + card pop
      // -----------------------------
      AFRAME.registerComponent("stadium-follow-marker", {
        schema: { graceMs: { type: "int", default: 800 } },
        init: function () {
          this.marker = document.querySelector("#sjsuMarker");
          this.anchor = this.el;
          this.stadium = this.anchor.querySelector("#stadium");
          this.card = this.anchor.querySelector("#dayNightCard");
          this.tracking = false;
          this.hideTimeout = null;

          this.anchor.object3D.visible = false;
          if (this.card) this.card.setAttribute("visible", false);

          if (!this.marker) {
            console.warn("stadium-follow-marker: #sjsuMarker not found");
            return;
          }

          this.marker.addEventListener("markerFound", () => this.onMarkerFound());
          this.marker.addEventListener("markerLost", () => this.onMarkerLost());
        },
        onMarkerFound: function () {
          this.tracking = true;

          if (this.hideTimeout) {
            clearTimeout(this.hideTimeout);
            this.hideTimeout = null;
          }

          this.anchor.object3D.visible = true;

          if (this.stadium) {
            this.stadium.setAttribute("scale", "0.003 0.003 0.003");
            this.stadium.setAttribute("position", "0 -0.2 0");
            this.stadium.emit("popin");
          }

          // Show + pop card
          if (this.card) {
            this.card.setAttribute("visible", true);
            this.card.setAttribute("scale", "0.001 0.001 0.001");
            this.card.emit("cardpop");
          }
        },
        onMarkerLost: function () {
          this.tracking = false;

          this.hideTimeout = setTimeout(() => {
            if (!this.tracking) {
              this.anchor.object3D.visible = false;
              if (this.card) this.card.setAttribute("visible", false);
            }
          }, this.data.graceMs);
        },
        tick: function () {
          if (!this.tracking || !this.marker) return;
          this.anchor.object3D.position.copy(this.marker.object3D.position);
          this.anchor.object3D.quaternion.copy(this.marker.object3D.quaternion);
        },
      });

      // -----------------------------
      // Day/Night lighting + card swap
      // -----------------------------
      const statusLine = document.getElementById("statusLine");

      function isNightAt(lat, lon, date = new Date()) {
        if (!window.SunCalc) return false;
        const pos = SunCalc.getPosition(date, lat, lon);
        const altitudeDeg = pos.altitude * 180 / Math.PI;
        return altitudeDeg < -6; // civil twilight
      }

      function isNightByClock(date = new Date()) {
        const h = date.getHours();
        return h >= 19 || h < 7;
      }

      function applyLighting(night) {
        const ambient = document.getElementById("ambientLight");
        const dir = document.getElementById("dirLight");
        if (!ambient || !dir) return;

        if (night) {
          ambient.setAttribute("light", "intensity", 0.35);
          ambient.setAttribute("light", "color", "#223344");
          dir.setAttribute("light", "intensity", 0.65);
          dir.setAttribute("light", "color", "#88aaff");
        } else {
          ambient.setAttribute("light", "intensity", 0.9);
          ambient.setAttribute("light", "color", "#ffffff");
          dir.setAttribute("light", "intensity", 1.2);
          dir.setAttribute("light", "color", "#ffffff");
        }
      }

      function setCardTexture(night) {
        const plane = document.getElementById("cardPlane");
        if (!plane) return;
        plane.setAttribute("material", "src", night ? "#nightImg" : "#dayImg");
      }

      function updateStatus({ night, lat, lon, acc, source }) {
        const mode = night ? "NIGHT" : "DAY";
        const gpsLine = lat != null
          ? `GPS: ${lat.toFixed(6)}, ${lon.toFixed(6)} (±${Math.round(acc)}m)`
          : `GPS: not used (${source})`;
        statusLine.textContent = `${gpsLine}\nLighting: ${mode}  |  Card: ${night ? "night.png" : "day.png"}`;
      }

      function applyMode(night, meta = {}) {
        applyLighting(night);
        setCardTexture(night);
        updateStatus({ night, ...meta });
      }

      let lastFix = null;

      function startDayNight() {
        // immediate fallback
        applyMode(isNightByClock(), { source: "clock" });

        if (!navigator.geolocation) return;

        navigator.geolocation.watchPosition(
          (pos) => {
            lastFix = pos;
            const { latitude, longitude, accuracy } = pos.coords;
            const night = isNightAt(latitude, longitude);
            applyMode(night, { lat: latitude, lon: longitude, acc: accuracy, source: "gps+suncalc" });
          },
          () => {
            // if denied/fails, keep clock mode
            applyMode(isNightByClock(), { source: "clock (gps denied)" });
          },
          { enableHighAccuracy: true, maximumAge: 60000, timeout: 15000 }
        );
      }

      document.addEventListener("DOMContentLoaded", () => {
        startDayNight();

        // re-check every minute
        setInterval(() => {
          if (lastFix?.coords) {
            const { latitude, longitude, accuracy } = lastFix.coords;
            applyMode(isNightAt(latitude, longitude), { lat: latitude, lon: longitude, acc: accuracy, source: "gps+suncalc" });
          } else {
            applyMode(isNightByClock(), { source: "clock" });
          }
        }, 60 * 1000);
      });
    </script>
  </body>
</html>
